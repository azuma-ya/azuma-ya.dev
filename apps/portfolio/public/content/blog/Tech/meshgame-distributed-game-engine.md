---
title: MeshGame - 分散型ゲームエンジンを作っている話
createdAt: 2025-02-14
updatedAt: 2025-02-16
tags:
  - Game
  - Distributed
  - P2P
description: 中央サーバーに頼らない、検証可能で確定的な分散型ゲームエンジン「MeshGame」の設計思想と開発について紹介します。
type: InternalBlog
isPinned: true
---

自分のプログラミングを始めたきっかけはゲーム制作でした。世界で一番面白いゲームを作りたい!と思ってプログラミングを始め、最初はメモ帳を使ってhtml, javasciptを実直にコツコツと書いていたものです。
いつしかみんなで集まって、またオンラインでも遊べるゲームを作りたいと思い始めました。

一般的なオンラインゲームでは、サーバーがメインロジックを実行し、世界の"正史"を決定します。誰が何をしたのか、その行為は有効か、不正はないか——すべてを中央で検証し、結果を全員に配布します。つまりサーバーは単なる中継ではなく、「唯一の真実」を生成する装置です。

オンラインゲームを開発するうえで、サーバー必要となり、そこで初めて「ライブラリ」という概念を知り、**Node.js**に出会いました。

> 今までは簡単なアクタークラス、イベント管理、ループ処理でゲームを作っていました...

そしてNodejsでサーバーを立て、Socket.ioを使い、いくつかWebゲームを実装していきました。

しかしあるとき自分の費やす時間の大半が「インフラ運用」であることに気づいたのです。個人開発者にとって、サーバー運用は想像以上に重い負担です。常時稼働、スケーリング、セキュリティ対策、コスト、障害対応……ゲーム本体とは別の巨大なシステムを抱えることになります。

もし各プレイヤーの端末が同じロジックを実行し、互いに検証し合いながら正史を共有できるなら、中央サーバーは必須ではなくなります。サーバーに依存しないオンラインゲーム——それは技術的には難しくても、個人開発の自由度を大きく広げるはずです。

## MeshGame（仮） とは

現在「MeshGame」という分散型ゲームエンジンを開発しています。これは単なるマルチプレイヤー向けライブラリではありません。中央サーバーに頼らず、すべての参加者が独立して状態を検証し合い、コンセンサスを形成するトラストレスなゲーム基盤を目指しています。

MeshGame は、以下の 3 つの柱を中心に構築されたゲームエンジンです。

- **Verifiable（検証可能）**: すべての実行が正しく行われたことを数学的に証明できる
- **Distributed（分散型）**: 中央集権的なサーバーを必要とせず、P2P で動作する
- **Deterministic（確定的）**: 同じ入力に対し、すべてのノードが必ず同じ状態遷移を生成する

ゲームを以下のように定義しています。

> 「各参加者によって独立して実行される、確定的状態遷移システムである」

## なぜ「確定的」である必要があるのか

MeshGame の最も重要な原則は **確定的実行（Deterministic Execution）** です。

通常のオンラインゲームでは、サーバーが「正解」を持ち、クライアントはそれを信じるしかありません。しかし MeshGame では `(state, action, meta)` という入力が与えられたとき、すべてのノードが全く同じ `next state` を計算します。

これによって、以下の可能性が生まれます。

### チート耐性

不正な計算を行っても、他のノードとの整合性が取れなくなるため、即座に検知されます。

### 完全なリプレイ性

小さな入力ログだけで、誰でもゲームの全過程を完全に再現し、監査できます。

### ZK（ゼロ知識証明）への道

将来的には、ゲームの実行プロセスを ZK プロトコルでラップすることで、実行内容を公開せずに「正しい遷移が行われたこと」だけを証明できるようになります。

## アーキテクチャ

MeshGame のコア（`@meshgame/core`）は、疎結合なモジュール群で構成されています。

```
┌─────────────────────────────────────────────────────────┐
│                      MeshGame Core                      │
├──────────────┬──────────────┬──────────────┬────────────┤
│    Engine    │   Ordering   │   Security   │    Net     │
│  状態マシン   │   Lockstep   │   Identity   │  WebRTC    │
│              │  コンセンサス │   公開鍵暗号  │    Mesh    │
└──────────────┴──────────────┴──────────────┴────────────┘
```

### Engine

純粋な状態マシンです。レンダリングや UI に依存しません。

### Ordering（Lockstep）

サーバーなしでアクションの順序を合意するコンセンサス・アルゴリズムです。

### Security（Identity）

公開鍵暗号を用いたプレイヤー認証と署名付きの通信層です。

### Net（WebRTC Mesh）

ブラウザ間でもシームレスに直接通信可能なトランスポート層です。

## 開発ロードマップ

現在は分散基盤の開発とゲームエンジンの開発を並行して進めています。

### 分散基盤

P2P通信、コンセンサス、検証レイヤーなど、トラストレスな実行環境を実現するための基盤部分です。

| フェーズ | 内容                     | 状況     |
| -------- | ------------------------ | -------- |
| Phase 1  | P2P 同期実行（Lockstep） | 進行中   |
| Phase 2  | 状態ハッシュ・整合性検証 | 次の目標 |
| Phase 3  | コミットメント・スキーム | 計画中   |
| Phase 4  | ZK 証明統合              | 計画中   |

### ゲームエンジン

確定的な状態遷移を実現するゲームエンジン部分です。

| フェーズ | 内容               | 状況   |
| -------- | ------------------ | ------ |
| Phase 1  | 簡易エンジンの実装 | 完了   |
| Phase 2  | 汎用エンジンの設計 | 進行中 |
| Phase 3  | 汎用エンジンの実装 | 計画中 |
| Phase 4  | プラグインシステム | 計画中 |

簡易エンジンは分散基盤のテスト用に実装済みで、汎用的なゲームエンジンは現在設計段階です。

## ユースケース

MeshGame は、特に以下のような領域で力を発揮します。

### オンチェーン・ゲームのオフチェーン実行部

高速なレスポンスが必要な対戦を P2P で行い、結果だけを検証可能にします。ブロックチェーンの遅延を気にせず、リアルタイムな対戦が可能です。

### 完全な P2P ボードゲーム / RTS

サーバー代を気にせず、永続的に遊び続けられるゲームが実現できます。サーバーが落ちてもゲームは続きます。

### 分散型システムの研究

確定的コンピューティングやコンセンサス・アルゴリズムの実験プラットフォームとしても活用できます。

## 終わりに

MeshGame は、単なるゲーム開発ツールではありません。トラストレスなインタラクティブ計算の基盤を目指しています。

誰もが自分のルールを持ち寄り、検証可能な形で遊びの場を構築できる世界。そんな未来に向けて、一歩ずつコードを積み上げています。

興味があれば、今後の進展を見守っていただければ幸いです。

サンプルゲームとしての簡単な「[農業シミュレーション](https://farming.azuma-ya.dev)」ゲームを作りました。P2Pによる通信とLockstepによる順序決定をしています。
